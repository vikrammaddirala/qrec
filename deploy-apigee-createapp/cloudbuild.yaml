steps:
  # Step 1: Retrieve Google Auth Token
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'get-auth-token'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Get the auth token
        export build_token="$(gcloud auth print-access-token)"
        echo "build_token=${build_token}" > /workspace/auth-token.txt

  # Step 2: Install Apigee CLI and deploy the shared flow from dev to uat
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Install Apigee CLI
        echo "Installing Apigee CLI"
        curl -LO "https://github.com/apigee/apigeecli/releases/latest/download/apigeecli_Linux_x86_64.tar.gz"
        tar -xzf apigeecli_Linux_x86_64.tar.gz -C /usr/local/bin apigeecli

        # Source substitution variables
        shared_flow_name="commonSF_devops__v1"
        source_env="dev"
        target_env="uat"
        target_org="qrec-qa-apigee-nonprod"
        
        # Read the token from the previous step
        source /workspace/auth-token.txt
        
        # Deploy the shared flow from dev to uat environment
        echo "Deploying shared flow: ${shared_flow_name} from ${source_env} to ${target_env}"
        /usr/local/bin/apigeecli sharedflows deploy --name ${shared_flow_name} --fromenv ${source_env} --toenv ${target_env} --org ${target_org} --token ${build_token} --wait --ovr
