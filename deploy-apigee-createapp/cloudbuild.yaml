steps:
  # Step 1: Retrieve Google Auth Token
  - name: 'gcr.io/cloud-builders/gcloud'
    id: variables
    entrypoint: 'bash'
    args:
      - -c
      - |
        # Get the auth token
        export _BUILD_TOKEN=\"$(gcloud auth print-access-token)\"
        echo "_BUILD_TOKEN=${_BUILD_TOKEN}" > /workspace/auth-token.txt

  # Step 2: Install Apigee CLI and deploy the shared flow from dev to uat
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: deploy-shared-flow
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Install apigeecli
        echo "Installing apigeecli"
        source deploy-apigee-createapp/installapigeecli.sh

        # Set the path to include the apigeecli binary
        export APIGEE_PATH=/usr/local/bin:$APIGEE_PATH
        export PATH=$APIGEE_PATH:$PATH

        # Source substitution variables
        SHARED_FLOW_NAME="commonSF_devops__v1"
        SOURCE_ENV="dev"
        TARGET_ENV="uat"
        TARGET_ORG="qrec-qa-apigee-nonprod"
        
        # Read the token from the previous step
        source /workspace/auth-token.txt
        
        # Deploy the shared flow from dev to uat environment
        echo "Deploying shared flow: ${SHARED_FLOW_NAME} from ${SOURCE_ENV} to ${TARGET_ENV}"
        /usr/local/bin/apigeecli sharedflows deploy --name ${SHARED_FLOW_NAME} --fromenv ${SOURCE_ENV} --toenv ${TARGET_ENV} --org ${TARGET_ORG} --token ${BUILD_TOKEN} --wait --ovr
