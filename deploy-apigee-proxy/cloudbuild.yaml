steps:
  # Step 1: Export the proxy from the dev environment
  - name: 'gcr.io/cloud-builders/curl'
    id: 'Export Proxy'
    args:
      - '-X'
      - 'GET'
      - '-H'
      - 'Authorization: Bearer $(gcloud auth print-access-token)'
      - '-o'
      - 'exported_proxy.zip'
      - 'https://apigee.googleapis.com/v1/organizations/qrec-qa-apigee-nonprod/environments/dev/apis/helloworld/revisions/1?format=bundle'

  # Step 2: Import the proxy to the dev-int environment
  - name: 'gcr.io/cloud-builders/curl'
    id: 'Import Proxy'
    args:
      - '-X'
      - 'POST'
      - '-H'
      - 'Authorization: Bearer $(gcloud auth print-access-token)'
      - '-F'
      - 'file=@exported_proxy.zip'
      - 'https://apigee.googleapis.com/v1/organizations/qrec-qa-apigee-nonprod/apis?action=import&name=helloworld'

  # Step 3: Deploy the proxy to the dev-int environment
  - name: 'gcr.io/cloud-builders/curl'
    id: 'Deploy Proxy'
    args:
      - '-X'
      - 'POST'
      - '-H'
      - 'Authorization: Bearer $(gcloud auth print-access-token)'
      - '-H'
      - 'Content-Type: application/json'
      - '-d'
      - '{"name":"helloworld", "revision":"1", "environment":"dev-int"}'
      - 'https://apigee.googleapis.com/v1/organizations/qrec-qa-apigee-nonprod/environments/dev-int/apis/helloworld/revisions/1/deployments'

timeout: '3600s'

options:
  logging: CLOUD_LOGGING_ONLY
